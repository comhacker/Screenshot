# ScreenCapture 托盘模式使用说明

## 新增功能概述

现在 ScreenCapture 支持**后台运行模式**，可以最小化到系统托盘，并通过**全局快捷键**随时截图！

## 启动托盘模式

### 命令行启动

```bash
# 启动托盘模式（后台运行）
ScreenCapture.exe --tray

# 也可以结合其他参数
ScreenCapture.exe --tray --lang:en
ScreenCapture.exe --tray --path:"D:\Screenshots"
```

### 双击启动

如果您想让程序默认以托盘模式启动，可以：

1. **方式一：创建快捷方式**
   - 右键 `ScreenCapture.exe` → 创建快捷方式
   - 右键快捷方式 → 属性
   - 在"目标"后面添加 `--tray`
   - 例如：`"D:\ScreenCapture.exe" --tray`

2. **方式二：创建批处理文件**
   ```bat
   @echo off
   start "" "ScreenCapture.exe" --tray
   ```

3. **方式三：添加到开机启动**
   - 将上述快捷方式放到：
   - `%AppData%\Microsoft\Windows\Start Menu\Programs\Startup`

## 使用方法

### 1. 托盘图标

程序启动后会在系统托盘（右下角任务栏）显示图标：

![Tray Icon](./Res/logo.ico)

### 2. 托盘菜单

**右键点击托盘图标**可以打开菜单：

```
📷 截图           - 立即开始截图
⚙️ 设置           - 打开设置窗口
ℹ️ 关于           - 查看程序信息
❌ 退出           - 退出程序
```

### 3. 快速截图

有 **3 种方式** 触发截图：

1. ✅ **单击托盘图标** - 鼠标左键点击
2. ✅ **双击托盘图标** - 双击更快
3. ✅ **按全局快捷键** - 默认是 `Ctrl+Alt+A`

### 4. 设置快捷键

**打开设置窗口**：
- 右键托盘图标 → 设置

**快捷键设置**：
1. 在"截图快捷键"框中按下您想要的组合键
2. 例如：按下 `Ctrl+Shift+X`
3. 点击"保存"按钮

**推荐的快捷键组合**：
- `Ctrl+Alt+A` （默认，类似 QQ 截图）
- `Ctrl+Shift+X`
- `Ctrl+Alt+S`
- `Ctrl+Alt+C`
- `F1` 到 `F12` （功能键）

**注意事项**：
- ⚠️ 避免使用系统快捷键（如 `Ctrl+C`, `Ctrl+V`）
- ⚠️ 快捷键必须包含至少一个修饰键（Ctrl/Alt/Shift/Win）
- ⚠️ 如果快捷键已被其他程序占用，会显示注册失败

### 5. 其他设置

**开机自动启动**：
- 勾选后，Windows 启动时自动运行托盘程序
- （此功能需要写入注册表，代码中已预留接口）

**显示托盘通知**：
- 是否显示气泡提示信息
- 如：热键注册成功、程序启动等

## 完整使用流程示例

### 场景 1：日常使用

```bash
# 1. 启动程序（后台运行）
ScreenCapture.exe --tray

# 2. 程序最小化到托盘

# 3. 需要截图时，按 Ctrl+Alt+A

# 4. 拖拽选择区域，绘图，保存

# 5. 继续工作，需要时再按快捷键
```

### 场景 2：配置快捷键

```bash
# 1. 启动托盘程序
ScreenCapture.exe --tray

# 2. 右键托盘图标 → 设置

# 3. 在快捷键输入框按下 Ctrl+Shift+S

# 4. 点击保存

# 5. 现在按 Ctrl+Shift+S 就能截图了！
```

### 场景 3：开机自启 + 固定保存路径

```bat
REM 创建 startup.bat
@echo off
start "" "D:\ScreenCapture.exe" --tray --path:"D:\Screenshots" --lang:zhcn

REM 将此文件放到启动文件夹
REM %AppData%\Microsoft\Windows\Start Menu\Programs\Startup
```

## 退出程序

托盘模式下，关闭截图窗口不会退出程序。

**退出方法**：
1. 右键托盘图标 → 退出
2. 任务管理器强制结束

## 配置文件位置

程序设置保存在：

```
Windows Registry:
HKEY_CURRENT_USER\Software\ScreenCapture\Settings

或者（取决于 Qt 版本）:
%AppData%\ScreenCapture\Settings.ini
```

**保存的设置包括**：
- 快捷键配置（修饰键 + 虚拟键码）
- 是否开机自启
- 是否显示托盘通知

## 技术实现说明

### 新增文件

```
App/
├── TrayIcon.h/cpp        # 系统托盘图标类
├── HotKeyManager.h/cpp   # 全局热键管理器

Win/
├── WinSettings.h/cpp     # 设置窗口
```

### 核心技术

1. **系统托盘**：`QSystemTrayIcon`
2. **全局热键**：Windows API `RegisterHotKey` + `WM_HOTKEY` 消息
3. **配置管理**：`QSettings`
4. **热键监听**：隐藏窗口接收 Windows 消息

### 热键工作原理

```cpp
// 1. 创建隐藏窗口
HotKeyManager (继承 QWidget)

// 2. 注册热键
RegisterHotKey(hwnd, id, MOD_CONTROL | MOD_ALT, VK_A);

// 3. 接收消息
bool nativeEvent(...) {
    if (msg->message == WM_HOTKEY) {
        emit hotKeyPressed(id);  // 发送信号
    }
}

// 4. 响应截图
connect(hotKeyManager, &HotKeyManager::hotKeyPressed, []() {
    new WinFull();  // 显示截图窗口
});
```

## 常见问题

### Q1: 托盘图标不显示？
**A**: 
- 检查任务栏设置，可能被隐藏了
- 右键任务栏 → 任务栏设置 → 选择显示哪些图标

### Q2: 快捷键不起作用？
**A**:
- 检查是否与其他程序冲突（QQ、微信、截图工具）
- 尝试更换快捷键组合
- 以管理员权限运行程序

### Q3: 如何查看当前快捷键？
**A**:
- 右键托盘图标 → 关于
- 或者打开设置窗口查看

### Q4: 能否同时运行多个实例？
**A**: 
- 不建议，可能导致快捷键冲突
- 原程序已有单实例检查机制

### Q5: 托盘模式下还能用命令行截图吗？
**A**:
- 可以再开一个进程执行命令行截图
- 例如：`ScreenCapture.exe --cap:fullscreen,clipboard`

## 高级用法

### 1. 结合 AutoHotKey

```ahk
; 使用 AHK 也可以触发截图
^!A::
{
    Run "D:\ScreenCapture.exe" --cap:custom,clipboard
}
```

### 2. 多套快捷键配置

可以创建多个快捷方式，使用不同参数：

```
快捷方式1: --tray
快捷方式2: --cap:custom,clipboard
快捷方式3: --cap:long
```

### 3. 整合到其他应用

```javascript
// Node.js / Electron
const { spawn } = require('child_process');

// 后台运行托盘程序
spawn('ScreenCapture.exe', ['--tray']);

// 或者直接截图
spawn('ScreenCapture.exe', ['--cap:custom,clipboard']);
```

## 兼容性

- ✅ Windows 10 1607+
- ✅ Windows 11
- ✅ 支持多显示器
- ✅ 支持高DPI

## 反馈与建议

如有问题或建议，请访问：
https://github.com/xland/ScreenCapture/issues

---

**Enjoy! 愉快地使用截图工具！** 📸





