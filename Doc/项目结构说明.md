# ScreenCapture 项目结构说明

## 项目概述

ScreenCapture 是一个基于 Qt6/C++ 开发的功能强大的 Windows 截图工具。项目采用模块化设计，代码结构清晰，易于维护和扩展。

**主要技术栈：**
- C++ 17
- Qt 6 (Core, Widgets, GUI, Concurrent, Network, Svg)
- Visual Studio 2022
- Windows 10 SDK

## 目录结构

```
ScreenCapture/
├── App/                    # 应用程序核心模块
├── Win/                    # 窗口管理模块
├── Shape/                  # 图形绘制模块
├── Tool/                   # 工具栏组件模块
├── Res/                    # 资源文件
├── Doc/                    # 文档和图片
├── Licence/                # 开源许可证
├── build/                  # 构建输出目录
│   ├── Release/           # 发布版本
│   └── VSTemp/            # 临时编译文件
├── main.cpp               # 程序入口
├── res.qrc                # Qt 资源文件
└── ScreenCapture.vcxproj  # Visual Studio 项目文件
```

## 核心模块详解

### 1. App 模块 (`App/`)

应用程序的核心控制层，负责程序初始化、命令行参数解析和全局配置管理。

**主要文件：**
- `App.h/cpp` - 应用程序主控制器
  - 命令行参数解析 (`--path`, `--lang`, `--comp`, `--cap`, `--pin`, `--tool`)
  - 程序初始化与销毁
  - 全局配置管理（保存路径、压缩参数、工具栏配置等）
  
- `Lang.h/cpp` - 多语言支持
  - 支持简体中文和英文
  - 语言文件加载与切换
  
- `Util.h/cpp` - 工具函数库
  - 通用辅助函数
  - 系统相关工具方法
  
- `State.h` - 全局状态枚举
  - 定义应用程序各种状态

- `Res.h/rc` - Windows 资源文件
  - 应用程序图标
  - 版本信息

**主要功能：**
- 解析启动参数并执行相应功能
- 管理截图保存路径、压缩质量等全局配置
- 控制程序退出码（用于集成到其他应用）

### 2. Win 模块 (`Win/`)

窗口管理模块，包含所有窗口类和界面交互逻辑。

**主要文件：**

- `WinBase.h/cpp` - 窗口基类
  - 所有窗口的公共基类
  - 定义窗口的基本行为和接口
  - 管理绘图图层、工具栏等

- `WinFull.h/cpp` - 全屏截图窗口
  - 主截图界面，覆盖所有屏幕
  - 处理鼠标拖拽选择截图区域
  - 管理取景框和像素信息显示
  - 支持跨屏幕截图

- `WinLong.h/cpp` - 长截图窗口
  - 滚动截图功能实现
  - 自动拼接多屏截图
  
- `WinLongTip.h/cpp` - 长截图提示窗口
  - 长截图操作指引界面

- `WinPin.h/cpp` - 钉图窗口
  - 将截图钉在桌面上
  - 支持鼠标滚轮缩放
  - 支持在钉图上继续绘制

- `WinPinBtns.h/cpp` - 钉图窗口按钮组
  - 钉图窗口的工具按钮

- `Canvas.h/cpp` - 画布组件
  - 绘图层管理
  - Shape 对象的渲染和交互
  - 撤销/重做功能实现

- `CutMask.h/cpp` - 截图遮罩
  - 未选中区域的半透明遮罩
  - 窗口高亮检测
  - 选区边框绘制

- `PixelInfo.h/cpp` - 像素信息显示
  - 放大镜功能
  - RGB/HEX/CMYK 颜色显示
  - 鼠标坐标显示
  - 快捷键复制颜色值

- `LongCapFuncs.h` - 长截图功能函数集

**窗口层级关系：**
```
WinBase (基类)
├── WinFull (全屏截图)
├── WinLong (长截图)
└── WinPin (钉图窗口)
```

### 3. Shape 模块 (`Shape/`)

图形绘制模块，实现所有绘图工具的形状类。采用面向对象设计，每种形状都继承自基类。

**类继承结构：**

```
ShapeBase (抽象基类)
├── ShapeRectBase (矩形类基类)
│   ├── ShapeRect (矩形)
│   ├── ShapeEraserRect (矩形橡皮擦)
│   └── ShapeMosaicRect (矩形马赛克)
│
├── ShapeEllipse (椭圆)
│
├── ShapeLineBase (线条类基类)
│   ├── ShapeLine (直线/曲线)
│   ├── ShapeArrow (箭头)
│   ├── ShapeEraserLine (线条橡皮擦)
│   └── ShapeMosaicLine (线条马赛克)
│
├── ShapeText (文本标注)
├── ShapeTextContainer (文本容器)
├── ShapeTextInput (文本输入框)
└── ShapeNumber (序号标注)
```

**主要文件：**

- `ShapeBase.h/cpp` - 形状基类
  - 定义形状的通用接口（绘制、鼠标交互等）
  - 拖拽点（Dragger）管理
  - 形状状态管理

- `ShapeState.h` - 形状状态枚举
  - `temp`: 临时绘制中
  - `normal`: 正常状态
  - `hover`: 鼠标悬停
  - `selected`: 已选中

**各形状类功能：**

| 形状类 | 功能说明 |
|-------|---------|
| ShapeRect | 矩形/正方形绘制，支持填充和边框 |
| ShapeEllipse | 椭圆/圆形绘制，支持填充和边框 |
| ShapeLine | 直线/曲线绘制，按住 Shift 绘制直线 |
| ShapeArrow | 箭头绘制，可调整箭头方向和大小 |
| ShapeNumber | 自动递增的序号标注 |
| ShapeText | 文本标注，支持富文本编辑 |
| ShapeMosaicRect | 矩形区域马赛克 |
| ShapeMosaicLine | 线条马赛克 |
| ShapeEraserRect | 矩形橡皮擦 |
| ShapeEraserLine | 线条橡皮擦 |

**形状交互机制：**
1. 每个形状可以有多个拖拽点（Dragger）
2. 鼠标悬停时显示拖拽点
3. 拖动拖拽点可以调整形状大小和位置
4. 支持删除已绘制的形状

### 4. Tool 模块 (`Tool/`)

工具栏组件模块，包含所有工具按钮和控制器。

**主要文件：**

- `BtnBase.h/cpp` - 按钮基类
  - 工具栏按钮的公共基类
  - 按钮状态管理
  - 鼠标交互处理

- `Btn.h/cpp` - 普通按钮
  - 一般功能按钮（保存、复制、关闭等）

- `BtnCheck.h/cpp` - 可选中按钮
  - 绘图工具按钮（矩形、椭圆等）
  - 支持选中/取消选中状态

- `ColorCtrl.h/cpp` - 颜色选择器
  - 预设颜色面板
  - 自定义颜色选择
  - 颜色历史记录

- `StrokeCtrl.h/cpp` - 笔触粗细控制器
  - 线条粗细选择
  - 5 个预设粗细级别

- `ToolBase.h/cpp` - 工具栏基类
  - 工具栏容器基类

- `ToolMain.h/cpp` - 主工具栏
  - 绘图和操作工具按钮
  - 支持通过 `--tool` 参数自定义

- `ToolSub.h/cpp` - 子工具栏
  - 颜色和笔触选择器
  - 填充选项

- `ToolLong.h/cpp` - 长截图工具栏
  - 长截图模式专用工具栏

**工具栏布局：**
```
ToolMain (主工具栏)
├── 绘图工具按钮 (rect, ellipse, arrow, number, line, text, mosaic, eraser)
├── 分隔符 |
├── 操作按钮 (undo, redo)
├── 分隔符 |
└── 功能按钮 (pin, clipboard, save, close)

ToolSub (子工具栏)
├── ColorCtrl (颜色选择器)
└── StrokeCtrl (笔触控制器)
```

### 5. 资源文件

**Res 目录：**
- `logo.ico` - 应用程序图标
- `iconfont.ttf` - 图标字体文件（用于工具栏图标）

**res.qrc：**
- Qt 资源配置文件，包含所有嵌入资源

**Doc 目录：**
- 项目文档和截图
- 开发笔记和技术文档

## 程序执行流程

### 1. 启动流程

```cpp
main()
  └─> App::init()
      ├─> 解析命令行参数
      ├─> 检查单进程（防止多实例）
      ├─> 设置语言
      └─> 根据参数执行操作：
          ├─> --cap:area → 区域截图
          ├─> --cap:fullscreen → 全屏截图
          ├─> --cap:custom → 自定义截图
          ├─> --cap:long → 长截图
          ├─> --pin:clipboard → 钉住剪贴板图片
          ├─> --pin:file → 钉住文件图片
          ├─> --pin:area → 钉住区域图片
          └─> 无参数 → 显示全屏截图窗口
```

### 2. 截图流程（以自定义截图为例）

```
用户启动程序
  └─> 创建 WinFull 窗口（全屏）
      ├─> 捕获所有屏幕画面
      ├─> 显示 CutMask（遮罩）
      └─> 显示 PixelInfo（像素信息）

用户拖拽鼠标选择区域
  └─> CutMask 更新选区
      ├─> 绘制半透明遮罩
      ├─> 检测并高亮窗口
      └─> 显示选区尺寸

选区确定后
  └─> 显示 ToolMain（主工具栏）
      └─> 显示 ToolSub（子工具栏）

用户绘制标注
  └─> 选择工具（如矩形）
      └─> Canvas 创建对应 Shape 对象
          ├─> 鼠标按下：开始绘制
          ├─> 鼠标移动：更新形状
          └─> 鼠标释放：完成绘制

用户保存截图
  └─> 点击保存按钮
      ├─> Canvas 合成所有图层
      ├─> 应用压缩参数
      ├─> 保存到文件或剪贴板
      └─> 设置退出码并关闭程序
```

### 3. 绘图系统工作原理

```
Canvas (画布)
  ├─> bgLayer (背景图层)
  │   └─> 截图的原始图像
  │
  ├─> shapes (形状列表)
  │   ├─> ShapeRect 1
  │   ├─> ShapeArrow 2
  │   ├─> ShapeText 3
  │   └─> ...
  │
  └─> paintEvent()
      ├─> 绘制背景图层
      ├─> 依次绘制所有 Shape
      └─> 绘制选中 Shape 的拖拽点
```

**撤销/重做机制：**
- 维护形状列表的历史记录
- Ctrl+Z: 回退到上一个状态
- Ctrl+Y: 前进到下一个状态

## 命令行参数系统

### 参数解析架构

```cpp
App::getCmd()  // 解析命令行参数为 QMap
  └─> parseCmd()  // 分发到具体功能
      ├─> --lang → 设置语言
      ├─> --path → 保存路径
      ├─> --comp → 压缩参数
      ├─> --tool → 工具栏配置
      ├─> --cap  → 截图功能
      └─> --pin  → 钉图功能
```

### 退出码系统

程序通过退出码告知调用方执行结果，便于集成到其他应用：

| 退出码 | 含义 |
|-------|------|
| 0 | 未定义 |
| 1 | 点击关闭按钮退出 |
| 2 | 点击鼠标右键退出 |
| 3 | 按 ESC 键退出 |
| 4 | 复制 RGB 颜色时退出 |
| 5 | 复制 HEX 颜色时退出 |
| 6 | 复制 CMYK 颜色时退出 |
| 7 | 复制鼠标位置时退出 |
| 8 | 保存到文件时退出 |
| 9 | 保存到剪贴板时退出 |

## 设计模式应用

### 1. 策略模式
- **应用场景：** 不同的 Shape 类型
- **实现：** ShapeBase 定义接口，各具体形状类实现不同的绘制策略

### 2. 命令模式
- **应用场景：** 撤销/重做功能
- **实现：** 维护 Shape 对象的历史记录栈

### 3. 工厂模式
- **应用场景：** 根据工具类型创建不同的 Shape 对象
- **实现：** Canvas 根据当前选中的工具创建对应的 Shape

### 4. 单例模式
- **应用场景：** App 类的静态方法提供全局配置访问
- **实现：** static 成员函数和变量

## 技术特点

### 1. 性能优化
- **双缓冲绘图：** 避免闪烁
- **脏区域更新：** 只重绘需要更新的部分
- **图像缓存：** 避免重复计算

### 2. 跨屏支持
- 自动检测所有显示器
- 计算虚拟桌面总尺寸
- 支持不同 DPI 的显示器

### 3. 高 DPI 支持
- 自动缩放 UI 元素
- DPI 感知的坐标转换
- 适配 4K、5K 显示器

### 4. 内存管理
- 使用 Qt 的对象树自动管理生命周期
- 智能指针避免内存泄漏
- 及时释放大图像资源

## 构建说明

### 开发环境要求
- Visual Studio 2022 或更高版本
- Qt 6.x
- Windows 10 SDK
- C++ 17 编译器

### 构建步骤

1. **配置 Qt 环境**
   ```bash
   # 设置 Qt 安装路径环境变量
   set Qt6_DIR=C:\Qt\6.x.x\msvc2022_64
   ```

2. **打开项目**
   ```bash
   # 使用 Visual Studio 打开
   ScreenCapture.sln
   ```

3. **编译**
   - 选择 Release 配置
   - 生成解决方案
   - 输出位于 `build/Release/`

4. **部署**
   ```bash
   # 使用 deploy.bat 脚本打包依赖
   deploy.bat
   ```

### 发布包内容

```
Release/
├── ScreenCapture.exe       # 主程序
├── Qt6Core.dll            # Qt 核心库
├── Qt6Gui.dll             # Qt GUI 库
├── Qt6Widgets.dll         # Qt Widgets 库
├── Qt6Concurrent.dll      # Qt 并发库
├── Qt6Network.dll         # Qt 网络库
├── Qt6Svg.dll             # Qt SVG 库
├── platforms/             # Qt 平台插件
├── imageformats/          # 图像格式插件
├── styles/                # 样式插件
├── tls/                   # TLS 插件
└── translations/          # 翻译文件
```

## 扩展开发指南

### 添加新的绘图工具

1. **创建 Shape 类**
   ```cpp
   // Shape/ShapeCustom.h
   class ShapeCustom : public ShapeBase {
       Q_OBJECT
   public:
       void paint(QPainter* painter) override;
       void mouseDrag(QMouseEvent* event) override;
       // ...
   };
   ```

2. **在 Canvas 中注册**
   ```cpp
   // Win/Canvas.cpp
   if (toolType == "custom") {
       currentShape = new ShapeCustom(this);
   }
   ```

3. **添加工具栏按钮**
   ```cpp
   // Tool/ToolMain.cpp
   auto btnCustom = new BtnCheck("custom", this);
   ```

### 添加新的命令行参数

```cpp
// App/App.cpp
bool App::parseCmd(const QMap<QString, QString>& params) {
    if (params.contains("yourcmd")) {
        QString value = params["yourcmd"];
        // 处理参数
        return true;
    }
    return false;
}
```

### 自定义工具栏

通过 `--tool` 参数可以完全自定义工具栏布局：

```bash
# 只保留基本工具
ScreenCapture.exe --tool:"rect,arrow,|,clipboard,save,close"

# 为长截图定制工具栏
ScreenCapture.exe --cap:long --tool:"pin,clipboard,save"
```

## 项目依赖

### Qt 模块
- **QtCore**: 核心功能（对象模型、事件系统等）
- **QtGui**: GUI 基础（绘图、图像、字体等）
- **QtWidgets**: 控件和窗口
- **QtConcurrent**: 多线程支持
- **QtNetwork**: 网络功能（用于更新检查等）
- **QtSvg**: SVG 图像支持

### Windows API
- **User32.dll**: 窗口和输入处理
- **Gdi32.dll**: 图形设备接口
- **Dwmapi.dll**: 桌面窗口管理器
- **Shell32.dll**: Shell 功能

## 注：

原项目链接： https://github.com/xland/ScreenCapture

