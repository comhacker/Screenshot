## 后台模式与全局热键改动逐行说明

### 1) 新增 App::startTrayMode 接口（初始化托盘与热键，关闭最后窗口不退出）

```438:511:App/App.cpp
void App::startTrayMode()
{
    // 已在托盘运行直接返回
    if (trayIcon != nullptr) return;

    // 关闭最后一个窗口时不退出，以便托盘常驻
    qApp->setQuitOnLastWindowClosed(false);

    // 创建托盘图标
    trayIcon = new TrayIcon();

    // 创建热键管理器
    hotKeyManager = HotKeyManager::instance();
    hotKeyManager->show(); // 确保有原生窗口接收 WM_HOTKEY

    // 加载并注册热键
    QSettings settings("ScreenCapture", "Settings");
    int hotKeyModifiers = settings.value("HotKey/Modifiers", MOD_CONTROL | MOD_ALT).toInt();
    int hotKeyVirtualKey = settings.value("HotKey/VirtualKey", int('A')).toInt();
    bool ok = hotKeyManager->registerHotKey(1, hotKeyModifiers, hotKeyVirtualKey);

    // 连接信号：热键与托盘菜单均触发截图
    QObject::connect(hotKeyManager, &HotKeyManager::hotKeyPressed, [](int id) {
        if (id == 1) {
            new WinFull();
        }
    });
    QObject::connect(trayIcon, &TrayIcon::captureRequested, []() {
        new WinFull();
    });
    QObject::connect(trayIcon, &TrayIcon::settingsRequested, []() {
        WinSettings* settingsWin = new WinSettings();
        QObject::connect(settingsWin, &WinSettings::hotKeyChanged, [](int modifiers, int virtualKey) {
            if (hotKeyManager) {
                hotKeyManager->registerHotKey(1, modifiers, virtualKey);
            }
        });
        settingsWin->show();
    });

    // 提示用户注册结果
    if (ok) {
        QStringList parts;
        if (hotKeyModifiers & MOD_CONTROL) parts << "Ctrl";
        if (hotKeyModifiers & MOD_ALT) parts << "Alt";
        if (hotKeyModifiers & MOD_SHIFT) parts << "Shift";
        if (hotKeyModifiers & MOD_WIN) parts << "Win";
        QString keyStr;
        if (hotKeyVirtualKey >= 'A' && hotKeyVirtualKey <= 'Z') {
            keyStr = QChar(hotKeyVirtualKey);
        } else if (hotKeyVirtualKey >= VK_F1 && hotKeyVirtualKey <= VK_F24) {
            keyStr = QString("F%1").arg(hotKeyVirtualKey - VK_F1 + 1);
        } else if (hotKeyVirtualKey >= '0' && hotKeyVirtualKey <= '9') {
            keyStr = QChar(hotKeyVirtualKey);
        } else {
            switch (hotKeyVirtualKey) {
            case VK_SPACE: keyStr = "Space"; break;
            case VK_TAB: keyStr = "Tab"; break;
            case VK_RETURN: keyStr = "Enter"; break;
            case VK_ESCAPE: keyStr = "Esc"; break;
            case VK_LEFT: keyStr = "Left"; break;
            case VK_RIGHT: keyStr = "Right"; break;
            case VK_UP: keyStr = "Up"; break;
            case VK_DOWN: keyStr = "Down"; break;
            default: keyStr = QString("VK_%1").arg(hotKeyVirtualKey); break;
            }
        }
        parts << keyStr;
        QString combo = parts.join("+");
        trayIcon->showMessage("ScreenCapture", Lang::get("hotkeyRegistered") + ": " + combo, QSystemTrayIcon::Information, 2000);
    } else {
        trayIcon->showMessage("ScreenCapture", Lang::get("hotkeyFailed"), QSystemTrayIcon::Warning, 3000);
    }
}
```

对应头文件新增声明：

```8:14:App/App.h
    static QStringList getTool();
    static void startTrayMode();
```

### 2) 工具栏新增“后台运行”按钮（点击后进入托盘常驻）

按钮点击处理：

```146:177:Tool/ToolMain.cpp
void ToolMain::btnClick(Btn* btn)
{
    auto win = (WinBase*)parent();
    if (btn->name == "clipboard") {
        win->saveToClipboard();
    }
    else if (btn->name == "save") {
        win->saveToFile();
    }
    else if (btn->name == "undo") {
        win->canvas->undo();
    }
    else if (btn->name == "redo") {
        win->canvas->redo();
    }
    else if (btn->name == "pin") {
        auto winFull = dynamic_cast<WinFull*>(parent());
        if (winFull) {
            winFull->pin();
        }
    }
    else if (btn->name == "close") {
        win->close();
        qApp->exit(1);
    }
    else if (btn->name == "background") {
        // 启动托盘与全局热键，并关闭当前截图窗口
        App::startTrayMode();
        auto w = qobject_cast<QWidget*>(parent());
        if (w) w->close();
    }
}
```

按钮工厂与默认工具栏加入：

```222:271:Tool/ToolMain.cpp
QWidget* ToolMain::getTool(const QString& toolName)
{
    ...
    else if (toolName == "close") {
        return new Btn("close", QChar(0xe6e7), this);
    }
    else if (toolName == "background") {
        auto b = new Btn("background", QChar(0xe6a3), this); // 图标占位
        b->setToolTip(Lang::get("runInBackground"));
        return b;
    }
    return nullptr;
}
```

```274:295:Tool/ToolMain.cpp
void ToolMain::initDefaultTool(QHBoxLayout* layout)
{
    ...
    layout->addWidget(new Btn("save", QChar(0xe6c0), this));
    {
        auto b = new Btn("background", QChar(0xe6a3), this);
        b->setToolTip(Lang::get("runInBackground"));
        layout->addWidget(b);
    }
    layout->addWidget(new Btn("close", QChar(0xe6e7), this));
}
```

默认工具栏宽度（Button 数量+1）：

```16:26:Tool/ToolMain.cpp
    if (tools.isEmpty()) {
        initDefaultTool(layout);
        setFixedSize(15 * btnW + 8, 32);
    }
```

### 3) 托盘图标类（系统托盘驻留与菜单）

构造与图标加载、气泡提示：

```7:45:App/TrayIcon.cpp
TrayIcon::TrayIcon(QObject* parent)
    : QSystemTrayIcon(parent)
    , hotKeyId(1)
    , hotKeyModifiers(MOD_CONTROL | MOD_ALT)
    , hotKeyVirtualKey(int('A'))
{
    settings = new QSettings("ScreenCapture", "Settings", this);
    
    // 设置托盘图标
    QIcon trayIco = QIcon(":/Res/logo.ico");
    if (trayIco.isNull()) {
        trayIco = QIcon("Res/logo.ico");
    }
    setIcon(trayIco);
    if (!QSystemTrayIcon::isSystemTrayAvailable()) {
        QMessageBox::warning(nullptr, "ScreenCapture", "System tray is not available.");
    }
    setToolTip("ScreenCapture - " + Lang::get("readyToCapture"));
    ...
    show();
    // 显示启动提示
    showMessage(
        "ScreenCapture",
        Lang::get("trayStarted") + "\n" + Lang::get("hotkey") + ": " + getHotKeyString(),
        QSystemTrayIcon::Information,
        2000
    );
}
```

右键菜单“截图/设置/关于/退出”与点击托盘触发截图：

```52:82:App/TrayIcon.cpp
void TrayIcon::createMenu()
{
    menu = new QMenu();
    ...
    setContextMenu(menu);
}
```

```84:90:App/TrayIcon.cpp
void TrayIcon::onActivated(QSystemTrayIcon::ActivationReason reason)
{
    if (reason == QSystemTrayIcon::Trigger || reason == QSystemTrayIcon::DoubleClick) {
        // 单击或双击托盘图标时触发截图
        emit captureRequested();
    }
}
```

### 4) 热键管理（隐藏原生窗口接收 WM_HOTKEY）

隐藏窗口 + 强制 winId + show：

```6:16:App/HotKeyManager.cpp
HotKeyManager::HotKeyManager(QWidget* parent)
    : QWidget(parent)
{
    // 创建隐藏窗口用于接收热键消息
    setWindowFlags(Qt::Tool | Qt::FramelessWindowHint);
    setAttribute(Qt::WA_TranslucentBackground);
    resize(1, 1);
    move(-10000, -10000);
    winId();   // 强制创建原生窗口句柄
    show();    // 隐藏在屏幕外，但确保接收消息
}
```

处理 WM_HOTKEY（兼容 Qt6 事件通道）：

```73:87:App/HotKeyManager.cpp
bool HotKeyManager::nativeEvent(const QByteArray& eventType, void* message, qintptr* result)
{
    if (eventType == "windows_generic_MSG" || eventType == "windows_dispatcher_MSG") {
        MSG* msg = static_cast<MSG*>(message);
        
        if (msg->message == WM_HOTKEY) {
            int id = msg->wParam;
            qDebug() << "HotKey pressed:" << id;
            emit hotKeyPressed(id);
            return true;
        }
    }
    
    return QWidget::nativeEvent(eventType, message, result);
}
```

### 5) 设置窗口（热键自定义，Qt6 QKeyCombination）

默认热键与显示：

```7:19:Win/WinSettings.cpp
WinSettings::WinSettings(QWidget* parent)
    : QDialog(parent)
    , currentModifiers(MOD_CONTROL | MOD_ALT)
    , currentVirtualKey(int('A'))
{
    ...
}
```

将热键转换为 QKeyCombination 以显示在 QKeySequenceEdit：

```85:107:Win/WinSettings.cpp
void WinSettings::loadSettings()
{
    ...
    QKeySequence keySeq(QKeyCombination(qtMod, static_cast<Qt::Key>(qtKey)));
    hotKeyEdit->setKeySequence(keySeq);
    ...
}
```

重置为默认热键：

```145:152:Win/WinSettings.cpp
void WinSettings::onResetClicked()
{
    // 重置为默认值
    currentModifiers = MOD_CONTROL | MOD_ALT;
    currentVirtualKey = int('A');
    
    QKeySequence keySeq(QKeyCombination(Qt::ControlModifier | Qt::AltModifier, Qt::Key_A));
    hotKeyEdit->setKeySequence(keySeq);
    ...
}
```

从 QKeySequence 获取 QKeyCombination 并转为 Win 虚拟键：

```158:174:Win/WinSettings.cpp
void WinSettings::onKeySequenceChanged(const QKeySequence& keySequence)
{
    if (keySequence.isEmpty()) {
        return;
    }
    // 获取第一个按键组合（Qt6: QKeyCombination）
    QKeyCombination combo = keySequence[0];
    // 提取修饰键
    Qt::KeyboardModifiers qtMod = combo.keyboardModifiers();
    currentModifiers = qtModifiersToWinMod(qtMod);
    // 提取主键
    int qtKey = static_cast<int>(combo.key());
    currentVirtualKey = qtKeyToWinVK(qtKey);
}
```

### 6) 语言包词条（按钮提示、气泡提示文案）

中文新增：

```72:99:App/Lang.cpp
    // 托盘和设置相关
    dic.insert("readyToCapture", "就绪，点击或按快捷键截图");
    dic.insert("trayStarted", "程序已在后台运行");
    dic.insert("hotkey", "快捷键");
    dic.insert("capture", "截图");
    dic.insert("settings", "设置");
    dic.insert("about", "关于");
    dic.insert("exit", "退出");
    dic.insert("hotkeyRegistered", "快捷键已注册");
    dic.insert("hotkeyFailed", "快捷键注册失败，可能与其他程序冲突");
    dic.insert("aboutText", "一个功能强大的截图工具");
    dic.insert("success", "成功");
    dic.insert("settingsSaved", "设置已保存！快捷键将在下次启动时生效。");
    dic.insert("save", "保存");
    dic.insert("cancel", "取消");
    dic.insert("resetDefault", "恢复默认");
    dic.insert("hotkeySettings", "快捷键设置");
    dic.insert("captureHotkey", "截图快捷键");
    dic.insert("hotkeyHint", "提示：推荐使用 Ctrl+Alt+字母 组合，避免与系统快捷键冲突");
    dic.insert("generalSettings", "常规设置");
    dic.insert("autoStartWithWindows", "开机自动启动");
    dic.insert("showTrayNotifications", "显示托盘通知");
    dic.insert("runInBackground", "后台运行");
```

英文新增：

```144:167:App/Lang.cpp
    // Tray and settings
    dic.insert("readyToCapture", "Ready, click or press hotkey to capture");
    dic.insert("trayStarted", "Running in background");
    dic.insert("hotkey", "Hotkey");
    dic.insert("capture", "Capture");
    dic.insert("settings", "Settings");
    dic.insert("about", "About");
    dic.insert("exit", "Exit");
    dic.insert("hotkeyRegistered", "Hotkey registered");
    dic.insert("hotkeyFailed", "Failed to register hotkey, may conflict with other programs");
    dic.insert("aboutText", "A powerful screenshot tool");
    dic.insert("success", "Success");
    dic.insert("settingsSaved", "Settings saved! Hotkey will take effect on next startup.");
    dic.insert("save", "Save");
    dic.insert("cancel", "Cancel");
    dic.insert("resetDefault", "Reset to Default");
    dic.insert("hotkeySettings", "Hotkey Settings");
    dic.insert("captureHotkey", "Capture Hotkey");
    dic.insert("hotkeyHint", "Tip: Use Ctrl+Alt+Letter combinations to avoid conflicts with system hotkeys");
    dic.insert("generalSettings", "General Settings");
    dic.insert("autoStartWithWindows", "Start with Windows");
    dic.insert("showTrayNotifications", "Show tray notifications");
    dic.insert("runInBackground", "Run in background");
```

### 7) 资源文件（托盘图标打包进资源）

```1:6:res.qrc
<RCC>
    <qresource prefix="/">
        <file>Res/iconfont.ttf</file>
        <file>Res/logo.ico</file>
    </qresource>
</RCC>
```

### 8) 头文件声明（App.h 新增接口）

```5:14:App/App.h
class App
{
public:
    static void init();
    static void dispose();
    static QString getSavePath();
    static std::tuple<int, int> getCompressVal();
    static int getCustomCap();
    static QStringList getTool();
    static void startTrayMode();
```

——以上为所有与“后台运行 + 全局热键 + 托盘菜单 + 快捷键设置”相关的新增/修改点，并逐行给出了位置与代码。若需要对某个片段进一步解释其调用链或触发路径，可继续在本文件追加说明。


